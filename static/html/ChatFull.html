<div id="chat-holder" class="fixed bottom-20 right-14 mb-2 mr-4 bg-gradient-to-t from-transparent to-gray-700/70 text-white z-50 p-2 rounded-lg shadow-lg w-80">
    <div id="chat-history" class="hidden p-2 h-[14rem] overflow-y-auto backdrop-blur-md space-y-2 rounded-lg shadow-md"></div>
    <div class="flex items-center rounded-lg mt-2 gap-1">
        <div id="chat-sending-to" class="text-sm font-semibold text-white/50"></div>
        <input id="chat-input-text" type="text" placeholder="Type a message..." class="bg-transparent flex-1 p-1 text-white rounded-md outline-none">
        <button id="chat-send-btn" class="ml-2">
            <img src="{{ baseURI | safe }}/cd?type=image&name=send-button.png" alt="Send" class="w-4 h-4">
        </button>
    </div>
</div>
<script id="script-chat">
    const MESSAGE_NODES = {
        PARTY: autoCapitaliseWord("PARTY"),
        TEAM: autoCapitaliseWord("TEAM"),
        FRIEND: autoCapitaliseWord("FRIEND"),
        YOU: autoCapitaliseWord("YOU"),
        SYSTEM: autoCapitaliseWord("SYSTEM"),
    }

    function openChatHistory() {
        waitForElementPresence("#chat-history", (chatHistory)=>{
            chatHistory.style.display = "block"
        })
        if (typeof closeMusicTray !== "undefined") closeMusicTray()
    }

    function closeChatHistory() {
        waitForElementPresence("#chat-history", (chatHistory)=>{
            chatHistory.style.display = ""
        })
    }

    function receiveText(data) {
        let isValid = false
        let backgroundDiv = document.createElement("div"),  senderSpan = document.createElement("span"), textPara = document.createElement("p")
        if (data["FROM"] === MESSAGE_NODES.SYSTEM) { // From system
            backgroundDiv.className = "flex items-start space-x-1 text-gray-700 rounded-lg py-1 px-2 bg-white/10"
            senderSpan.className = "text-sm font-bold color-change"
            textPara.className = "text-sm font-semibold italic color-change"
            isValid = true
        } else if (data["FROM"] === MESSAGE_NODES.YOU) { // From Me
            backgroundDiv.className = "flex items-start space-x-1 text-gray-700 rounded-lg py-1 px-2"
            senderSpan.className = "text-sm font-semibold text-yellow-500"
            textPara.className = "text-sm text-gray-300"
            if (allFriendUsernames.has(data["TO"])) { // Me - Friend
                data["FROM"] = data["TO"]
                data["TO"] = "TO"
                isValid = true
            } else if ([MESSAGE_NODES.PARTY, MESSAGE_NODES.TEAM].includes(data["TO"])) { // Me - Other
                isValid = true
            }
        } else if (data["TO"] === MESSAGE_NODES.YOU) { // To Me
            backgroundDiv.className = "flex items-start space-x-1 text-gray-700 rounded-lg py-1 px-2"
            senderSpan.className = "text-sm font-semibold text-red-500"
            textPara.className = "text-sm text-gray-300"
            if (allFriendUsernames.has(data["FROM"])) {
                data["TO"] = "FROM"
                isValid = true
            } else if ([MESSAGE_NODES.SYSTEM, MESSAGE_NODES.PARTY, MESSAGE_NODES.TEAM].includes(data["TO"])) {
                isValid = true
            }
        } else if (data["TO"] === MESSAGE_NODES.PARTY) {
            backgroundDiv.className = "flex items-start space-x-1 text-gray-700 rounded-lg py-1 px-2"
            senderSpan.className = "text-sm font-semibold text-purple-500"
            textPara.className = "text-sm text-gray-300"
            isValid = true
        } else if (data["TO"] === MESSAGE_NODES.TEAM) {
            backgroundDiv.className = "flex items-start space-x-1 text-gray-700 rounded-lg py-1 px-2"
            senderSpan.className = "text-sm font-semibold text-green-500"
            textPara.className = "text-sm text-gray-300"
            isValid = true
        }
        if (isValid) {
            senderSpan.innerText = `[${data["TO"]}] ${data["FROM"]}: `
            textPara.innerText = data["TEXT"]
            backgroundDiv.append(senderSpan)
            backgroundDiv.append(textPara)
            waitForElementPresence("#chat-history", (historyDiv) => {
                historyDiv.append(backgroundDiv)
                historyDiv.scrollTop = historyDiv.scrollHeight
            })
        }
    }

    function sendTriggered() {
        waitForElementPresence("#chat-input-text", (input)=>{
            if (input.value !== "") {
                console.log("SENDING", {PURPOSE: "CHAT", "TO": selectedReceiver, "TEXT": input.value})
                sendCustomMessage({PURPOSE: "CHAT", "TO": selectedReceiver, "TEXT": input.value})
                receiveText({"FROM": MESSAGE_NODES.YOU, "TO": selectedReceiver, "TEXT": input.value})
                input.value = ""
            }
        })
    }

    function changeChatReceiver(capitalisedReceiver) {
        let unmodifiedReceiver = capitalisedReceiver
        capitalisedReceiver = autoCapitaliseWord(capitalisedReceiver)
        if (capitalisedReceiver===MESSAGE_NODES.TEAM) {
            selectedReceiver = capitalisedReceiver
            waitForElementPresence("#chat-sending-to", (element)=>{
                element.innerText = `[${capitalisedReceiver}]:`
            })
            return true
        } else if (capitalisedReceiver===MESSAGE_NODES.PARTY) {
            selectedReceiver = capitalisedReceiver
            waitForElementPresence("#chat-sending-to", (element)=>{
                element.innerText = `[${capitalisedReceiver}]:`
            })
            return true
        } else if (allFriendUsernames.has(unmodifiedReceiver)) {
            selectedReceiver = unmodifiedReceiver
            waitForElementPresence("#chat-sending-to", (element)=>{
                element.innerText = `[${unmodifiedReceiver}]:`
            })
            console.log(selectedReceiver)
            return true
        }
        console.log("error", selectedReceiver, capitalisedReceiver, unmodifiedReceiver)
        return false
    }


    waitForElementPresence("#chat-input-text", (input)=>{
        input.addEventListener("input", function() {
            input.value = input.value.trim()
            let content = input.value
            if (content[0] === "/") {
                if (changeChatReceiver(content.slice(1)) === true) {
                    input.value = ""
                }
            }
        })
        input.addEventListener("focusin", function() {
            chatFocusCount++
            openChatHistory()
        })
        input.addEventListener("focusout", function() {
            chatFocusCount--
            if (chatFocusCount===0) closeChatHistory()
        })
        input.addEventListener("keydown", function(e) {
            if (e.key === "Enter") {
                e.preventDefault()
                sendTriggered()
            }
        })
    })

    waitForElementPresence("#chat-send-btn", (sendButton)=>{
        sendButton.addEventListener("click", function() {
            sendTriggered()
        })
    })

    waitForElementPresence("#chat-holder", (chatHolder)=>{
        chatHolder.addEventListener("mouseenter", function() {
            openChatHistory()
            chatFocusCount++
        })
        chatHolder.addEventListener("mouseleave", function() {
            chatFocusCount--
            if (chatFocusCount===0) closeChatHistory()
        })
    })

    let chatFocusCount = 0
    let selectedReceiver = ""
    changeChatReceiver(MESSAGE_NODES.PARTY.toUpperCase())
</script>

