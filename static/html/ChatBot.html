<div class="flex flex-col items-center justify-center w-full">
    <div class="w-96 bg-gray-800 text-white rounded-2xl shadow-2xl overflow-hidden border border-gray-700">
        <!-- Header -->
        <div class="bg-gray-700 p-4 text-center font-bold text-lg border-b border-gray-600">Chatbot</div>

        <!-- Chat Messages -->
        <div id="chat-container" class="h-72 overflow-y-auto p-4 space-y-3">
            <div class="flex items-start">
                <div class="bg-gray-700 text-gray-300 p-3 rounded-xl max-w-xs shadow-md">Hello! How can I assist you today?</div>
            </div>
        </div>

        <!-- Input Box -->
        <div class="bg-gray-700 p-4 flex items-center border-t border-gray-600">
            <input type="text" id="message-input" placeholder="Type a message..." class="bg-gray-800 text-white w-full py-2 px-4 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 shadow-inner">
            <button id="chatbot-send-button" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 ml-3 rounded-xl shadow-md">Send</button>
        </div>
        <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
        <script id="script-chatbot">

            waitForElementPresence("#message-input", (input)=>{
                input.addEventListener("keydown", function(e) {
                    if (e.key === "Enter") {
                        e.preventDefault()
                        sendChatbotMessage()
                    }
                })
                waitForElementPresence("#chatbot-send-button", (button=>{
                    button.addEventListener("click", ()=>{
                        sendChatbotMessage()
                    })
                }))
            })

            function sendChatbotMessage() {
                const text = document.getElementById("message-input").value.trim()
                if (text) {
                    sendCustomMessage({PURPOSE: "CHATBOT_MESSAGE", MESSAGE: text})
                    document.getElementById("message-input").value = ""
                }
            }

            function receiveChatbotMessage(data) {
                let self = data["IS_SELF"];
                let messageID = data["MESSAGE_ID"];
                let messageText = data["TEXT"];
                let messageElement = document.getElementById(`chatbot-message-${messageID}`);

                // Use marked library to parse the markdown
                let text = marked.parse(messageText).trim();

                // Clean up the text, removing <p> tags if they are around the message
                if (text.startsWith("<p>") && text.endsWith("</p>")) {
                    text = text.slice(3, -4);
                }

                // Ensure that inline code is styled properly
                // We replace <code> tags with custom styling for inline code
                text = text.replace(/<code>(.*?)<\/code>/g, '<code class="bg-gray-800 text-white px-1 rounded">$1</code>');

                const chatContainer = document.getElementById("chat-container");

                if (messageElement === null) {
                    // Create a new message wrapper div
                    let messageWrapper = document.createElement("div");
                    messageWrapper.classList.add("flex", "items-start");

                    if (self) messageWrapper.classList.add("justify-end");

                    // Create the message element
                    messageElement = document.createElement("div");
                    messageElement.id = `chatbot-message-${messageID}`;
                    messageElement.classList.add(
                        "p-3", "rounded-xl", "max-w-xs", "shadow-md",
                        self ? "bg-blue-500" : "bg-gray-700",
                        self ? "text-white" : "text-gray-300"
                    );

                    // Set the inner HTML of the message element to the parsed markdown
                    messageElement.innerHTML = text;

                    // Append the message element to the message wrapper
                    messageWrapper.appendChild(messageElement);

                    // Append the message wrapper to the chat container
                    chatContainer.appendChild(messageWrapper);
                } else {
                    // If the message already exists, append the new parsed content
                    messageElement.innerHTML += text;
                }
            }


        </script>
    </div>
    </div>